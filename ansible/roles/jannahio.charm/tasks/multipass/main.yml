---
# Implements:
# https://juju.is/docs/sdk/set-up-your-development-environment
- name: "Kubernetes on Ubuntu VM environment"
  block:
    # Create a VM, and mount local repository path,
    - name: "Create an Ubuntu VM, an environment for building container images"
      shell: |
        multipass launch \
        -n "{{ Jannah.stages.bootstrap.build.vm.name }}" \
        -m "{{ Jannah.stages.bootstrap.build.vm.memory }}" \
        -c "{{ Jannah.stages.bootstrap.build.vm.cpus }}" \
        -d "{{ Jannah.stages.bootstrap.build.vm.disk }}";
      async: 600
      poll: 5
      register: multipass_launch
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_launch
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Mount the working directory"
      shell: |
        multipass mount {{ Jannah.global.ansible.working_dir }} \
        {{ Jannah.stages.bootstrap.build.vm.name }}:{{ Jannah.global.ansible.working_dir }}
      register: multipass_infra_mount_working_directory
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_mount_working_directory
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Initialize lxd"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- lxd init --auto;
      async: 600
      poll: 5
      register: multipass_infra_charm_lxd_init
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_charm_lxd_init
      tags:
        - "multipass_infra"
        - "operator_e2e"

    - name: "install charmcraft, and juju"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo snap install charmcraft --classic;
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo snap install juju --channel 3.0/stable;
      async: 600
      poll: 5
      register: multipass_infra_install_charmcraft_and_juju
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_install_charmcraft_and_juju
      tags:
        - "multipass_infra"
        - "operator_e2e"

    - name: "install microk8s"
      shell: |
        # Install Microk8s from snap:
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo snap install microk8s --channel 1.25-strict/stable
      async: 600
      poll: 5
      register: multipass_infra_install_microk8s
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_install_microk8s
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "add ubuntu to snap_microk8s"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo usermod -a -G snap_microk8s ubuntu;
      async: 600
      poll: 5
      register: multipass_infra_add_ubuntu_to_snap_microk8s
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_add_ubuntu_to_snap_microk8s
      tags:
        - "multipass_infra"
        - "operator_e2e"
    #        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
    #        -- sudo chown -f -R ubuntu {{ Jannah.global.ansible.working_dir }}
    - name: "Give the ubuntu user permissions to read the ~/.kube, and Jannah.global.ansible.working_dir"
      shell: |  
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo chown -f -R ubuntu ~/.kube;
        exit 0;
      async: 600
      poll: 5
      register: multipass_infra_chown_kube_and_working_dir
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_chown_kube_and_working_dir
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Create the 'microk8s' group"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- newgrp snap_microk8s;
      async: 600
      poll: 5
      register: multipass_infra_create_microk8s
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_create_microk8s
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Enable the necessary MicroK8s addons:"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo microk8s enable hostpath-storage dns
      async: 600
      poll: 5
      register: multipass_infra_enable_microK8s_addons
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_enable_microK8s_addons
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Set up a short alias for the Kubernetes CLI:"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo snap alias microk8s.kubectl kubectl;
        # Since the juju package is strictly confined, you also need to manually create a path
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- mkdir -p ~/.local/share;
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju clouds;
      async: 600
      poll: 5
      register: multipass_infra_install_charmcraft
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_install_charmcraft
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Install juju controller into microk8s cloud"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju bootstrap microk8s {{ Jannah.stages.bootstrap.build.juju.controller.name }};
      async: 600
      poll: 5
      register: multipass_infra_install_juju_controller_into_microk8s_cloud
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_install_juju_controller_into_microk8s_cloud
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Create a workspace/model, on the controller"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju add-model {{ Jannah.stages.bootstrap.build.juju.model.name }};
      async: 600
      poll: 5
      register: multipass_infra_create_a_workspace_model_on_the_controller
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_create_a_workspace_model_on_the_controller
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - name: "Make ephemeral directory"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- mkdir -vp $MOLECULE_EPHEMERAL_DIRECTORY/;
      args:
        chdir: "$MOLECULE_EPHEMERAL_DIRECTORY/"
      async: 600
      poll: 5
      register: multipass_infra_install_docker
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_install_docker
      tags:
        - "multipass_infra"
        - "operator_e2e"
    # sudo snap install docker
    - name: "install docker"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- curl -fsSL https://get.docker.com -o get-docker.sh;
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- sudo sh get-docker.sh;
      args:
        chdir: "$MOLECULE_EPHEMERAL_DIRECTORY/"
      async: 600
      poll: 5
      register: multipass_infra_install_docker
      tags:
        - "multipass_infra"
        - "operator_e2e"
    - debug: var=multipass_infra_install_docker
      tags:
        - "multipass_infra"
        - "operator_e2e"
  rescue:
    - name: "Multipass Infra Exception"
      ansible.builtin.debug:
        msg: 'Multipass Infra Exception'
      register: multipass_infra_debug_resources
  ignore_errors: false
