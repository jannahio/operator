---
- name: "Deploy dependencies for Jannah"
  block:
    - name: "juju add-model kubeflow - exec"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju add-model kubeflow;
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju models;
      async: 1600
      poll: 15
      tags:
        - "deploy_dependencies"
        - "molecule_converge"
        - "operator_e2e"
    # juju deploy kubeflow --trust;
    - name: "juju deploy kubeflow --trust - exec"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju deploy kubeflow --trust  --channel=1.7/stable;
      async: 1600
      poll: 15
      tags:
        - "deploy_dependencies"
        - "molecule_converge"
        - "operator_e2e"

    - name: "juju deploy postgresql-k8s - exec"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju deploy mattermost-k8s;
      async: 1600
      poll: 15
      tags:
        - "deploy_dependencies"
        - "molecule_converge"
        - "operator_e2e"
    - name: "juju deploy postgresql-k8s - exec"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju deploy postgresql-k8s --channel 14/stable --trust;
      async: 1600
      poll: 15
      tags:
        - "deploy_dependencies"
        - "molecule_converge"
        - "operator_e2e"
    - name: "juju integrate mattermost-k8s postgresql-k8s:db - exec"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju integrate mattermost-k8s postgresql-k8s:db;
      async: 1600
      poll: 15
      tags:
        - "deploy_dependencies"
        - "molecule_converge"
        - "operator_e2e"
    - name: "juju integrate mattermost-k8s postgresql-k8s:db - exec"
      shell: |
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju config dex-auth public-url=http://10.64.140.43.nip.io;
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju config oidc-gatekeeper public-url=http://10.64.140.43.nip.io;
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju config dex-auth static-username=admin
        multipass exec {{ Jannah.stages.bootstrap.build.vm.name }} \
        -- juju config dex-auth static-password=Jannahio;
      async: 1600
      poll: 15
      tags:
        - "deploy_dependencies"
        - "molecule_converge"
        - "operator_e2e"
  rescue:
    - name: "Deploy dependencies for Jannah Exception"
      ansible.builtin.debug:
        msg: 'Deploy dependencies for Jannah Exception'
    - name: Re-emit failure
      vars:
        failed_task:
          result: '{{ ansible_failed_result }}'
      fail:
        msg: '{{ failed_task }}'
  ignore_errors: false
